name: Comment on Project Issue Progress

on:
  schedule:
    # æ¯æ—¥10æ™‚ã«å®Ÿè¡Œ
    - cron: '0 10 * * *'
  workflow_dispatch:

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  check_issue_progress:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Open Issues
        id: fetch_issues
        run: |
          REPO_OWNER=${{ github.repository_owner }}
          REPO_NAME=$(echo ${{ github.repository }} | cut -d'/' -f2)

          # GitHub APIã§ãƒªãƒã‚¸ãƒˆãƒªã®Issueã‚’å–å¾—
          ISSUES=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues?state=open")

          echo "$ISSUES" > issues.json

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Comment on Progress
        run: |
          # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "
import json
import requests
from datetime import datetime
import os

# GitHub Issueãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
with open('issues.json', 'r') as f:
    issues = json.load(f)

token = os.getenv('GITHUB_TOKEN')
headers = {
    'Authorization': f'token {token}',
    'Accept': 'application/vnd.github.v3+json'
}

now = datetime.now().date()
comment_message = \"ğŸ“Œ é€²æ—ç¢ºèªã®ãŠé¡˜ã„ã§ã™ã€‚\\né€²è¡ŒçŠ¶æ³ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚\"

for issue in issues:
    # å„Issueã®è©³ç´°
    issue_number = issue['number']
    issue_title = issue['title']
    issue_url = issue['html_url']
    milestone = issue.get('milestone', {})

    if milestone:
        # é–‹å§‹æ—¥ãƒ»çµ‚äº†æ—¥ã‚’å–å¾—
        start_date = milestone.get('start_date')
        due_date = milestone.get('due_on')

        if start_date and due_date:
            start_date_dt = datetime.strptime(start_date, '%Y-%m-%d').date()
            due_date_dt = datetime.strptime(due_date, '%Y-%m-%d').date()

            # é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã®é–“ã§ã‚ã‚Œã°ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
            if start_date_dt <= now <= due_date_dt:
                comment_url = f\"https://api.github.com/repos/{os.getenv('GITHUB_REPOSITORY')}/issues/{issue_number}/comments\"
                comment_payload = {
                    \"body\": f\"{comment_message}\\n**Issue**: [{issue_title}]({issue_url})\"
                }
                response = requests.post(comment_url, headers=headers, json=comment_payload)

                if response.status_code == 201:
                    print(f\"Issue #{issue_number} ã«é€²æ—ç¢ºèªã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸã€‚\")
                else:
                    print(f\"Issue #{issue_number} ã®ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\")" > comment_on_progress.py

          # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
          python3 comment_on_progress.py
